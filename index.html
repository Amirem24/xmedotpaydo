<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poolaki | پولکی</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#5b73e8">
    <link rel="icon" type="image/png" href="icon.png">
</head>
<body>

<!-- LOADING SCREEN -->
<div id="loading-screen">
    <div class="loading-logo"></div>
    <div class="loading-bar-container">
        <div class="loading-bar" id="loading-bar"></div>
    </div>
    <div class="loading-text" id="loading-text">در حال راه‌اندازی...</div>
</div>

<div class="app-container" id="app-container">
    <header>
        <div class="logo">poolaki</div>
    </header>

    <main id="main-content">
        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="view-section active">
            <div class="balance-card">
                <div class="balance-label">موجودی کل</div>
                <div class="balance-amount" id="total-balance">۰ <span class="currency">تومان</span></div>
            </div>

            <div class="section-title">
                <span>حساب‌های من</span>
            </div>
            
            <div class="accounts-scroll" id="accounts-container"></div>

            <div class="section-title">
                <span>تراکنش‌های اخیر</span>
                <span class="see-all" onclick="switchView('history')">مشاهده همه</span>
            </div>

            <div class="transactions-list" id="recent-transactions"></div>
        </div>

        <!-- HISTORY VIEW -->
        <div id="view-history" class="view-section">
            <div class="section-title" style="margin-top: 10px;">همه تراکنش‌ها</div>
            <div class="search-container">
                <i class="material-icons search-icon">search</i>
                <input type="text" class="search-input" placeholder="جستجو در تراکنش‌ها..." id="transaction-search">
            </div>
            <div class="transactions-list" id="all-transactions"></div>
        </div>

        <!-- ACCOUNTS VIEW -->
        <div id="view-accounts" class="view-section">
            <div class="section-title" style="margin-top: 10px; justify-content: flex-end; gap:10px;">
                <button onclick="openAddAccountModal()" style="background:none; border:none; color:#fff; cursor:pointer; font-family: inherit;">
                    <i class="material-icons" style="vertical-align: middle;">add_circle_outline</i> افزودن حساب
                </button>
            </div>
            <div id="accounts-list-full"></div>
        </div>

        <!-- SETTINGS VIEW -->
        <div id="view-settings" class="view-section">
            <div class="section-title" style="margin-top: 10px;">تنظیمات</div>
            
            <!-- Group: Categories -->
            <div class="settings-group">
                <div class="settings-header">دسته بندی ها</div>
                <div class="settings-item" onclick="openCategoriesModal()" style="cursor: pointer;">
                    <div class="settings-icon"><i class="material-icons">label</i></div>
                    <div class="settings-info">
                        <h4>مدیریت دسته‌بندی‌ها</h4>
                        <p>مشاهده و حذف تگ‌های استفاده شده</p>
                    </div>
                    <i class="material-icons" style="margin-right:auto; color:rgba(255,255,255,0.5)">chevron_left</i>
                </div>
            </div>

            <!-- Group 1: Storage -->
            <div class="settings-group">
                <div class="settings-header">مدیریت حافظه</div>
                <div class="settings-item">
                    <div class="settings-icon"><i class="material-icons">storage</i></div>
                    <div class="settings-info">
                        <h4>وضعیت داده‌ها</h4>
                        <p id="storage-usage">در حال محاسبه...</p>
                    </div>
                </div>
                <button class="btn-danger-outline" onclick="resetAppData()">
                    <i class="material-icons">delete_forever</i>
                    حذف کل اطلاعات (ریست فکتوری)
                </button>
            </div>

            <!-- Group 2: Backup & Restore -->
            <div class="settings-group">
                <div class="settings-header">مدیریت فایل پشتیبان</div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-secondary" onclick="backupData()">
                        <i class="material-icons">cloud_download</i>
                        بکاپ (دانلود)
                    </button>
                    <button class="btn-secondary" onclick="document.getElementById('restore-file').click()">
                        <i class="material-icons">cloud_upload</i>
                        ریستور (آپلود)
                    </button>
                    <input type="file" id="restore-file" accept=".json" style="display: none;" onchange="restoreData(this)">
                </div>
                <p style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 10px; line-height: 1.5;">
                    نکته: با ریستور کردن، اطلاعات فعلی حذف و با فایل جدید جایگزین می‌شود.
                </p>
            </div>

            <!-- Group 3: Updates -->
            <div class="settings-group">
                <div class="settings-header">به‌روزرسانی</div>
                <div class="settings-item">
                    <div class="settings-icon"><i class="material-icons">system_update</i></div>
                    <div class="settings-info">
                        <h4>نسخه برنامه</h4>
                        <p>v1.3.0</p>
                    </div>
                </div>
                <button class="btn-primary-outline" onclick="checkForUpdate()">
                    بررسی و دریافت نسخه جدید
                </button>
            </div>
            
            <div style="text-align: center; color: rgba(255,255,255,0.3); font-size: 12px; margin-top: 20px; padding-bottom: 20px;">
                Poolaki Finance App
            </div>
        </div>
    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchView('dashboard')" id="nav-dashboard">
            <i class="material-icons">dashboard</i>
            <span>خانه</span>
        </div>
        <div class="nav-item" onclick="switchView('accounts')" id="nav-accounts">
            <i class="material-icons">account_balance_wallet</i>
            <span>حساب‌ها</span>
        </div>
        <div class="fab-add" onclick="openAddTransactionModal()">
            <i class="material-icons">add</i>
        </div>
        <div class="nav-item" onclick="switchView('history')" id="nav-history">
            <i class="material-icons">receipt_long</i>
            <span>گزارش</span>
        </div>
        <div class="nav-item" onclick="switchView('settings')" id="nav-settings">
            <i class="material-icons">settings</i>
            <span>تنظیمات</span>
        </div>
    </nav>

    <!-- TOAST CONTAINER -->
    <div class="toast-container" id="toast-container"></div>

    <!-- CUSTOM CONFIRM MODAL -->
    <div class="modal-overlay" id="modal-confirm" style="z-index: 2000;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirm-title">عنوان تایید</h3>
            </div>
            <p id="confirm-message" style="color: rgba(255,255,255,0.8); line-height: 1.6;">متن پیام</p>
            <div class="confirm-actions">
                <button class="btn-confirm-yes" id="btn-confirm-yes">بله، مطمئنم</button>
                <button class="btn-confirm-no" onclick="closeModal('modal-confirm')">انصراف</button>
            </div>
        </div>
    </div>

    <!-- SELECTION MODAL (REPLACES SELECT) -->
    <div class="modal-overlay" id="modal-selection" style="z-index: 1500;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="selection-title">انتخاب کنید</h3>
                <button class="close-modal" onclick="closeModal('modal-selection')">&times;</button>
            </div>
            <div class="selection-list" id="selection-list">
                <!-- Items injected via JS -->
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div class="modal-overlay" id="modal-transaction">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ثبت تراکنش جدید</h3>
                <button class="close-modal" onclick="closeModal('modal-transaction')">&times;</button>
            </div>
            <div class="type-selector">
                <div class="type-option selected" onclick="setTransType('expense')" id="opt-expense">هزینه</div>
                <div class="type-option" onclick="setTransType('income')" id="opt-income">درآمد</div>
                <div class="type-option" onclick="setTransType('transfer')" id="opt-transfer">انتقال</div>
            </div>
            <form id="form-transaction">
                <div class="form-group">
                    <label class="form-label">مبلغ (تومان)</label>
                    <input type="text" inputmode="numeric" id="trans-amount" class="form-input money-input" placeholder="۰" required>
                </div>
                <div class="form-group">
                    <label class="form-label">عنوان</label>
                    <input type="text" id="trans-title" class="form-input" placeholder="مثلا: خرید نان" required>
                </div>
                <div class="form-group">
                    <label class="form-label">دسته بندی (تگ)</label>
                    <input type="text" id="trans-tags" class="form-input" placeholder="مثلا: خانه (با فاصله جدا کنید)">
                    <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 5px;">حداکثر ۳ تگ. در صورت خالی بودن، #سایر ثبت می‌شود.</div>
                </div>
                
                <!-- CUSTOM SELECT: SOURCE ACCOUNT -->
                <div class="form-group">
                    <label class="form-label">حساب مبدا</label>
                    <input type="hidden" id="trans-account">
                    <div class="form-input select-trigger" id="trigger-trans-account" onclick="openAccountSelect('trans-account', 'انتخاب حساب مبدا')">
                        انتخاب کنید...
                    </div>
                </div>

                <!-- CUSTOM SELECT: TARGET ACCOUNT -->
                <div class="form-group" id="target-account-group" style="display:none;">
                    <label class="form-label">حساب مقصد</label>
                    <input type="hidden" id="trans-target-account">
                    <div class="form-input select-trigger" id="trigger-trans-target-account" onclick="openAccountSelect('trans-target-account', 'انتخاب حساب مقصد')">
                        انتخاب کنید...
                    </div>
                </div>

                <button type="submit" class="btn-primary">ثبت تراکنش</button>
            </form>
        </div>
    </div>

    <!-- Categories List Modal -->
    <div class="modal-overlay" id="modal-categories">
        <div class="modal-content" style="height: 80%;">
            <div class="modal-header">
                <h3>دسته بندی ها</h3>
                <button class="close-modal" onclick="closeModal('modal-categories')">&times;</button>
            </div>
            <div id="categories-list" style="padding-bottom: 20px;"></div>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div class="modal-overlay" id="modal-account">
        <div class="modal-content">
            <div class="modal-header">
                <h3>افزودن حساب جدید</h3>
                <button class="close-modal" onclick="closeModal('modal-account')">&times;</button>
            </div>
            <form id="form-account">
                <div class="form-group">
                    <label class="form-label">نام حساب / کارت</label>
                    <input type="text" id="acc-name" class="form-input" placeholder="مثلا: بانک صادرات" required>
                </div>
                <div class="form-group">
                    <label class="form-label">موجودی اولیه (تومان)</label>
                    <input type="text" inputmode="numeric" id="acc-balance" class="form-input money-input" placeholder="۰" value="۰">
                </div>
                
                <!-- CUSTOM SELECT: ACCOUNT TYPE -->
                <div class="form-group">
                    <label class="form-label">نوع حساب</label>
                    <input type="hidden" id="acc-type" value="card">
                    <div class="form-input select-trigger" id="trigger-acc-type" onclick="openTypeSelect()">
                        کارت بانکی
                    </div>
                </div>

                <button type="submit" class="btn-primary">ایجاد حساب</button>
            </form>
        </div>
    </div>

</div>

<script src="script.js"></script>
<script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(registration => {
            console.log('SW Registered');
        }).catch(error => {
            console.log('SW Registration Failed');
        });
    }
</script>
</body>
</html>
